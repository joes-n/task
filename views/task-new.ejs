<%- include('partials/header') %>

<div class="dashboard dashboard--centered">

    <% 
        const defaultStatus = typeof task !== 'undefined' && task.status ? task.status : 'pending';
        const defaultPriority = typeof task !== 'undefined' && task.priority ? task.priority : 'medium';
        const defaultStatusLabel = defaultStatus.toUpperCase().replace('-', ' ');
        const defaultPriorityLabel = defaultPriority.toUpperCase();
    %>

    <div class="task-form-wrapper">
        <% if (typeof error !== 'undefined') { %>
            <div class="alert alert-error">
                <span class="signalis-glitch" data-text="<%= error %>"><%= error %></span>
            </div>
        <% } %>

        <form action="/tasks" method="POST" class="task-edit-form">
            <div class="form-group">
                <label for="title" class="signalis-glitch" data-text="TITLE *">TITLE *</label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    value="<%= typeof task !== 'undefined' ? task.title : '' %>"
                    required
                    maxlength="200"
                    autofocus
                >
            </div>

            <div class="form-group">
                <label for="description" class="signalis-glitch" data-text="DESCRIPTION">DESCRIPTION</label>
                <textarea
                    id="description"
                    name="description"
                    rows="4"
                    maxlength="1000"
                ><%= typeof task !== 'undefined' ? task.description : '' %></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="signalis-glitch" data-text="STATUS">STATUS</label>
                    <div class="custom-select-wrapper custom-select-wrapper--form">
                        <div class="custom-select">
                            <div class="custom-select-trigger">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="<%= defaultStatusLabel %>"><%= defaultStatusLabel %></span>
                            </div>
                            <div class="custom-options">
                                <span class="custom-option <%= defaultStatus === 'pending' ? 'selected' : '' %>" data-value="pending">
                                    <span class="btn-label--baseline-fix signalis-glitch" data-text="PENDING">PENDING</span>
                                </span>
                                <span class="custom-option <%= defaultStatus === 'in-progress' ? 'selected' : '' %>" data-value="in-progress">
                                    <span class="btn-label--baseline-fix signalis-glitch" data-text="IN PROGRESS">IN PROGRESS</span>
                                </span>
                                <span class="custom-option <%= defaultStatus === 'completed' ? 'selected' : '' %>" data-value="completed">
                                    <span class="btn-label--baseline-fix signalis-glitch" data-text="COMPLETED">COMPLETED</span>
                                </span>
                            </div>
                        </div>
                        <input type="hidden" id="status" name="status" value="<%= defaultStatus %>">
                    </div>
                </div>

                <div class="form-group">
                    <label class="signalis-glitch" data-text="PRIORITY">PRIORITY</label>
                    <div class="custom-select-wrapper custom-select-wrapper--form">
                        <div class="custom-select">
                            <div class="custom-select-trigger">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="<%= defaultPriorityLabel %>"><%= defaultPriorityLabel %></span>
                            </div>
                            <div class="custom-options">
                                <span class="custom-option <%= defaultPriority === 'low' ? 'selected' : '' %>" data-value="low">
                                    <span class="btn-label--baseline-fix signalis-glitch" data-text="LOW">LOW</span>
                                </span>
                                <span class="custom-option <%= defaultPriority === 'medium' ? 'selected' : '' %>" data-value="medium">
                                    <span class="btn-label--baseline-fix signalis-glitch" data-text="MEDIUM">MEDIUM</span>
                                </span>
                                <span class="custom-option <%= defaultPriority === 'high' ? 'selected' : '' %>" data-value="high">
                                    <span class="btn-label--baseline-fix signalis-glitch" data-text="HIGH">HIGH</span>
                                </span>
                            </div>
                        </div>
                        <input type="hidden" id="priority" name="priority" value="<%= defaultPriority %>">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="dueDate" class="signalis-glitch" data-text="DUE">DUE</label>
                <input
                    type="datetime-local"
                    id="dueDate"
                    name="dueDate"
                    value="<%= typeof task !== 'undefined' ? task.dueDate : '' %>"
                >
            </div>

            <div style="display: flex; gap: 4%; width: 100%;">
                <button
                    type="submit"
                    class="btn btn-primary btn-outline-primary"
                    style="flex: 0 0 48%;"
                >
                    <span class="btn-label--baseline-fix signalis-glitch" data-text="ADD TASK">ADD TASK</span>
                </button>
                <a href="/tasks" class="btn btn-secondary" style="flex: 0 0 48%; text-align: center;">
                    <span class="btn-label--baseline-fix signalis-glitch" data-text="CANCEL">CANCEL</span>
                </a>
            </div>
        </form>
    </div>
</div>

    <div class="visual-effects-container">
        <div class="phosphor-mask"></div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const wrappers = document.querySelectorAll('.task-edit-form .custom-select-wrapper');
        if (!wrappers.length) return;

        const closeAllSelects = () => {
            document.querySelectorAll('.task-edit-form .custom-select.open').forEach(select => select.classList.remove('open'));
        };

        wrappers.forEach(wrapper => {
            const select = wrapper.querySelector('.custom-select');
            const trigger = wrapper.querySelector('.custom-select-trigger');
            const triggerLabel = trigger ? trigger.querySelector('.btn-label--baseline-fix') : null;
            const options = wrapper.querySelectorAll('.custom-option');
            const hiddenInput = wrapper.querySelector('input[type="hidden"]');

            if (!select || !trigger || !triggerLabel || !hiddenInput) return;

            const applySelection = (option) => {
                const optionLabel = option.querySelector('.btn-label--baseline-fix');
                const labelText = optionLabel && optionLabel.dataset.text
                    ? optionLabel.dataset.text
                    : option.textContent.trim();

                triggerLabel.dataset.text = labelText;
                triggerLabel.textContent = labelText;
                hiddenInput.value = option.dataset.value;

                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            };

            const currentValue = hiddenInput.value;
            const defaultOption = Array.from(options).find(opt => opt.dataset.value === currentValue);
            if (defaultOption) {
                applySelection(defaultOption);
            }

            trigger.addEventListener('click', (event) => {
                event.stopPropagation();
                document.querySelectorAll('.task-edit-form .custom-select').forEach(other => {
                    if (other !== select) {
                        other.classList.remove('open');
                    }
                });
                select.classList.toggle('open');
            });

            options.forEach(option => {
                option.addEventListener('click', (event) => {
                    event.stopPropagation();
                    applySelection(option);
                    select.classList.remove('open');
                });
            });
        });

        document.addEventListener('click', closeAllSelects);
    });
</script>

<%- include('partials/footer') %>
