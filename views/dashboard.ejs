<%- include('partials/header') %>

    <div class="dashboard">
        <div class="dashboard-header dashboard-header--actions">
            <a href="/tasks/new" class="btn btn-primary header-btn header-btn--add">
                <span class="btn-label--baseline-fix signalis-glitch" data-text="ADD TASK">ADD TASK</span>
            </a>
            <a href="/logout" class="btn btn-secondary header-btn header-btn--logout">
                <span class="btn-label--baseline-fix signalis-glitch" data-text="LOG OUT">LOG OUT</span>
            </a>
        </div>

        <div class="task-controls">
            <form action="/tasks" method="GET" class="search-box" id="task-filter-form">
                <div class="search-input-wrapper<%= filters.search ? ' has-value' : '' %>">
                    <input
                        type="text"
                        name="search"
                        placeholder="SEARCH TASKS"
                        aria-label="Search tasks"
                        value="<%= filters.search || '' %>">
                    <span class="search-input-placeholder">
                        <span class="signalis-glitch" data-text="SEARCH TASKS">SEARCH TASKS</span>
                    </span>
                </div>

                <div class="custom-select-wrapper">
                    <div class="custom-select">
                        <div class="custom-select-trigger">
                            <% const statusLabel = !filters.status ? 'ALL STATUS' : filters.status.toUpperCase().replace('-', ' ' ); %>
                            <span class="btn-label--baseline-fix signalis-glitch" data-text="<%= statusLabel %>">
                                <%= statusLabel %>
                            </span>
                        </div>
                        <div class="custom-options">
                            <span class="custom-option <%= !filters.status ? 'selected' : '' %>" data-value=""><span
                                    class="btn-label--baseline-fix signalis-glitch" data-text="ALL STATUS">ALL STATUS</span></span>
                            <span class="custom-option <%= filters.status === 'pending' ? 'selected' : '' %>"
                                data-value="pending"><span class="btn-label--baseline-fix signalis-glitch" data-text="PENDING">PENDING</span></span>
                            <span class="custom-option <%= filters.status === 'in-progress' ? 'selected' : '' %>"
                                data-value="in-progress"><span class="btn-label--baseline-fix signalis-glitch" data-text="IN PROGRESS">IN PROGRESS</span></span>
                            <span class="custom-option <%= filters.status === 'completed' ? 'selected' : '' %>"
                                data-value="completed"><span class="btn-label--baseline-fix signalis-glitch" data-text="COMPLETED">COMPLETED</span></span>
                        </div>
                    </div>
                    <input type="hidden" name="status" value="<%= filters.status || '' %>">
                </div>

                <div class="custom-select-wrapper">
                    <div class="custom-select">
                        <div class="custom-select-trigger">
                            <% const priorityLabel = !filters.priority ? 'ALL PRIORITY' : filters.priority.toUpperCase(); %>
                            <span class="btn-label--baseline-fix signalis-glitch" data-text="<%= priorityLabel %>">
                                <%= priorityLabel %>
                            </span>
                        </div>
                        <div class="custom-options">
                            <span class="custom-option <%= !filters.priority ? 'selected' : '' %>" data-value=""><span
                                    class="btn-label--baseline-fix signalis-glitch" data-text="ALL PRIORITY">ALL PRIORITY</span></span>
                            <span class="custom-option <%= filters.priority === 'low' ? 'selected' : '' %>"
                                data-value="low"><span class="btn-label--baseline-fix signalis-glitch" data-text="LOW">LOW</span></span>
                            <span class="custom-option <%= filters.priority === 'medium' ? 'selected' : '' %>"
                                data-value="medium"><span class="btn-label--baseline-fix signalis-glitch" data-text="MEDIUM">MEDIUM</span></span>
                            <span class="custom-option <%= filters.priority === 'high' ? 'selected' : '' %>"
                                data-value="high"><span class="btn-label--baseline-fix signalis-glitch" data-text="HIGH">HIGH</span></span>
                        </div>
                    </div>
                    <input type="hidden" name="priority" value="<%= filters.priority || '' %>">
                </div>

                <div class="custom-select-wrapper">
                    <div class="custom-select">
                        <div class="custom-select-trigger">
                            <% let sortLabel = 'BY DUE DATE';
                               if (filters.sort === 'newest') { sortLabel = 'NEWEST FIRST'; }
                               else if (filters.sort === 'oldest') { sortLabel = 'OLDEST FIRST'; }
                            %>
                            <span class="btn-label--baseline-fix signalis-glitch" data-text="<%= sortLabel %>"><%= sortLabel %></span>
                        </div>
                        <div class="custom-options">
                            <span
                                class="custom-option <%= filters.sort === 'dueDate' || !filters.sort ? 'selected' : '' %>"
                                data-value="dueDate"><span class="btn-label--baseline-fix signalis-glitch" data-text="BY DUE DATE">BY DUE DATE</span></span>
                            <span class="custom-option <%= filters.sort === 'newest' ? 'selected' : '' %>"
                                data-value="newest"><span class="btn-label--baseline-fix signalis-glitch" data-text="NEWEST FIRST">NEWEST FIRST</span></span>
                            <span class="custom-option <%= filters.sort === 'oldest' ? 'selected' : '' %>"
                                data-value="oldest"><span class="btn-label--baseline-fix signalis-glitch" data-text="OLDEST FIRST">OLDEST FIRST</span></span>
                        </div>
                    </div>
                    <input type="hidden" name="sort" value="<%= filters.sort || 'dueDate' %>">
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-label--baseline-fix signalis-glitch" data-text="SEARCH">SEARCH</span>
                </button>
            </form>
        </div>

        <% if (typeof tasks !=='undefined' && tasks.length> 0) { %>
            <div class="tasks-grid">
                <% tasks.forEach((task, index) => { %>
                    <a href="/tasks/<%= task._id %>/edit" class="task-card-link">
                        <div class="task-card">
                            
                            <div class="signalis-header">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="<%= task.title.toUpperCase() %>"><%= task.title.toUpperCase() %></span>
                            </div>

                            <div class="signalis-body<%= task.description ? '' : ' signalis-body--empty' %>">
                                
                                <div class="task-card-priority">
                                    <span class="signalis-glitch" data-text="[<%= task.priority.toUpperCase().substring(0,3) %>]">[<%= task.priority.toUpperCase().substring(0,3) %>]</span>
                                </div>

                                <% if (task.description) { %>
                                    <div class="signalis-description">
                                        <span class="signalis-glitch" data-text="<%= task.description %>"><%= task.description %></span>
                                    </div>
                                <% } else { %>
                                    <div class="signalis-no-description signalis-description">
                                        <span class="signalis-glitch" data-text="NO DESCRIPTION">NO DESCRIPTION</span>
                                    </div>
                                <% } %>

                                <% if (task.dueDate) { %>
                                    <div class="signalis-timer">
                                        <span class="task-countdown" data-due="<%= task.dueDate %>"></span>
                                    </div>
                                <% } else { %>
                                    <div class="signalis-timer signalis-timer--placeholder" aria-hidden="true"></div>
                                <% } %>

                            </div>

                            <% if (task.status !== 'completed') { %>
                                <div class="signalis-actions mark-complete-actions">
                                    <form action="/tasks/<%= task._id %>/complete" method="POST" style="display: inline; width: 100%;">
                                        <button type="submit" class="btn-secondary btn-small" style="color: inherit; width: 100%;">
                                            <span class="btn-label--baseline-fix signalis-glitch" data-text="MARK AS DONE">MARK AS DONE</span>
                                        </button>
                                    </form>
                                </div>
                            <% } %>
                            <% if (task.description) { %>
                                <div class="signalis-actions signalis-actions--inline">
                                    <form action="/tasks/<%= task._id %>?_method=DELETE" method="POST" style="display: inline; width: 100%;" class="delete-task-form">
                                        <button type="submit" class="btn-secondary btn-small delete-task-btn" data-task-id="<%= task._id %>" data-task-title="<%= task.title %>" style="color: inherit; width: 100%;">
                                            <span class="btn-label--baseline-fix signalis-glitch" data-text="DELETE">DELETE</span>
                                        </button>
                                    </form>
                                </div>
                            <% } else { %>
                                <div class="signalis-actions signalis-actions--overlay">
                                    <form action="/tasks/<%= task._id %>?_method=DELETE" method="POST" style="display: inline; width: 100%;" class="delete-task-form">
                                        <button type="submit" class="btn-secondary btn-small delete-task-btn" data-task-id="<%= task._id %>" data-task-title="<%= task.title %>" style="color: inherit; width: 100%;">
                                            <span class="btn-label--baseline-fix signalis-glitch" data-text="DELETE">DELETE</span>
                                        </button>
                                    </form>
                                </div>
                            <% } %>
                        </div>
                    </a>
                <% }) %>
            </div>

            <!-- PROCRASTINATE Button -->
            <div class="procrastinate-container">
                <button id="procrastinate-btn" class="btn btn-procrastinate">
                    <span class="btn-label--baseline-fix signalis-glitch" data-text="PROCRASTINATE">PROCRASTINATE</span>
                </button>
            </div>
            <div id="procrastinate-confirm-overlay" class="confirm-overlay" aria-hidden="true">
                <div class="confirm-dialog" role="alertdialog" aria-labelledby="procrastinate-confirm-title" aria-describedby="procrastinate-confirm-note">
                    <div class="confirm-dialog__message">
                        <p id="procrastinate-confirm-note" class="signalis-glitch confirm-message" data-text="Postpone all tasks by 1 day?">Postpone all tasks by 1 day?</p>
                    </div>
                    <div class="confirm-actions">
                        <button type="button" class="btn confirm-action" id="confirm-procrastinate">
                            <span class="confirm-btn__plate">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="YES">YES</span>
                            </span>
                        </button>
                        <button type="button" class="btn cancel-action" id="cancel-procrastinate">
                            <span class="confirm-btn__plate">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="NO">NO</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete Task Confirmation Overlay -->
            <div id="delete-confirm-overlay" class="confirm-overlay" aria-hidden="true">
                <div class="confirm-dialog" role="alertdialog" aria-labelledby="delete-confirm-title" aria-describedby="delete-confirm-note">
                    <div class="confirm-dialog__message">
                        <p id="delete-confirm-note" class="signalis-glitch confirm-message">THIS WILL DELETE THE TASK PERMANENTLY.</p>
                    </div>
                    <div class="confirm-actions">
                        <button type="button" class="btn confirm-action" id="confirm-delete">
                            <span class="confirm-btn__plate">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="YES">YES</span>
                            </span>
                        </button>
                        <button type="button" class="btn cancel-action" id="cancel-delete">
                            <span class="confirm-btn__plate">
                                <span class="btn-label--baseline-fix signalis-glitch" data-text="NO">NO</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <% } else { %>
                <div class="empty-state">
                    <h3 class="signalis-glitch" data-text="NO TASK">NO TASK</h3>
                </div>
                <% } %>
    </div>

    <div id="regret-overlay">
        <div class="fatal-error-box">
            <h1 class="signalis-glitch" data-text="YOU WILL REGRET THIS LATER.">YOU WILL REGRET THIS LATER.</h1>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // --- SEARCH PLACEHOLDER GLITCH SYNC ---
            const searchInputWrapper = document.querySelector('.search-input-wrapper');
            const searchInput = searchInputWrapper ? searchInputWrapper.querySelector('input[name="search"]') : null;

            if (searchInput && searchInputWrapper) {
                const syncSearchPlaceholder = () => {
                    const hasValue = searchInput.value.trim().length > 0;
                    searchInputWrapper.classList.toggle('has-value', hasValue);
                };

                syncSearchPlaceholder();
                ['input', 'change'].forEach(evt => {
                    searchInput.addEventListener(evt, syncSearchPlaceholder);
                });
            }

            // --- ADD TASK VIEW TRANSITION ---
            const addTaskLink = document.querySelector('.header-btn--add');

            const ensureRouteOverlay = () => {
                let overlayEl = document.querySelector('.route-transition-overlay');
                if (!overlayEl) {
                    overlayEl = document.createElement('div');
                    overlayEl.className = 'route-transition-overlay';
                    document.body.appendChild(overlayEl);
                }
                return overlayEl;
            };

            const runAddTaskTransition = (destination) => {
                if (prefersReducedMotion) {
                    window.location.href = destination;
                    return;
                }

                if (document.startViewTransition) {
                    document.startViewTransition(() => {
                        window.location.href = destination;
                    });
                    return;
                }

                const overlayEl = ensureRouteOverlay();
                void overlayEl.offsetWidth;
                overlayEl.classList.add('route-transition-overlay--active');
                setTimeout(() => {
                    window.location.href = destination;
                }, 500);
            };

            addTaskLink?.addEventListener('click', (event) => {
                if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0) {
                    return;
                }
                event.preventDefault();
                runAddTaskTransition(addTaskLink.href);
            });

            // --- PROCRASTINATE BUTTON LOGIC (Kept Same) ---
            const btn = document.getElementById('procrastinate-btn');
            const overlay = document.getElementById('regret-overlay');
            const confirmOverlay = document.getElementById('procrastinate-confirm-overlay');
            const confirmProceedBtn = document.getElementById('confirm-procrastinate');
            const confirmCancelBtn = document.getElementById('cancel-procrastinate');
            let timeoutId = null;
            let lastFocusedElement = null;
            let isProcrastinating = false;

            const fadeOut = () => {
                overlay.classList.remove('active');
                if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }
            };

            const closeConfirmOverlay = () => {
                if (!confirmOverlay) return;
                confirmOverlay.classList.remove('confirm-overlay--visible');
                confirmOverlay.setAttribute('aria-hidden', 'true');
                if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    lastFocusedElement.focus();
                }
            };

            const openConfirmOverlay = () => {
                if (!confirmOverlay) return;
                lastFocusedElement = document.activeElement;
                confirmOverlay.classList.add('confirm-overlay--visible');
                confirmOverlay.setAttribute('aria-hidden', 'false');
                confirmProceedBtn?.focus();
            };

            const executeProcrastinate = async () => {
                if (isProcrastinating) return;
                isProcrastinating = true;

                if (overlay) {
                    overlay.style.transition = 'none';
                    overlay.classList.add('active');
                    void overlay.offsetWidth;
                    overlay.style.transition = 'opacity 0.1s ease-in-out, visibility 0.1s';
                    timeoutId = setTimeout(() => {
                        overlay.style.transition = 'opacity 3s ease-in-out, visibility 3s';
                        fadeOut();
                    }, 300);
                }

                try {
                    const response = await fetch('/tasks/procrastinate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const payload = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        throw new Error(payload.error || 'Failed to procrastinate tasks.');
                    }

                    if (typeof updateTaskGrid === 'function') {
                        await updateTaskGrid();
                    } else {
                        window.location.reload();
                    }

                } catch (err) {
                    console.error('Error procrastinating tasks:', err);
                    alert(err.message || 'Failed to procrastinate tasks.');
                } finally {
                    isProcrastinating = false;
                }
            };

            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirmOverlay) {
                        openConfirmOverlay();
                    } else {
                        executeProcrastinate();
                    }
                });
            }

            confirmProceedBtn?.addEventListener('click', () => {
                closeConfirmOverlay();
                executeProcrastinate();
            });

            confirmCancelBtn?.addEventListener('click', () => closeConfirmOverlay());

            confirmOverlay?.addEventListener('click', (event) => {
                if (event.target === confirmOverlay) {
                    closeConfirmOverlay();
                }
            });

            // --- DELETE TASK CONFIRMATION LOGIC ---
            const deleteOverlay = document.getElementById('delete-confirm-overlay');
            const confirmDeleteBtn = document.getElementById('confirm-delete');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const deleteConfirmNote = document.getElementById('delete-confirm-note');
            let deleteFormToSubmit = null;
            let pendingSubmitForm = null;

            const openDeleteConfirm = (taskTitle, formElement) => {
                if (!deleteOverlay) return;
                lastFocusedElement = document.activeElement;
                // Update the confirmation message with the task title
                if (deleteConfirmNote) {
                    const message = `Delete "${taskTitle}"?`;
                    deleteConfirmNote.textContent = message;
                    deleteConfirmNote.dataset.text = message;
                }
                deleteFormToSubmit = formElement;
                deleteOverlay.classList.add('confirm-overlay--visible');
                deleteOverlay.setAttribute('aria-hidden', 'false');
                confirmDeleteBtn?.focus();
            };

            const closeDeleteConfirm = (resetPending = true) => {
                if (!deleteOverlay) return;
                deleteOverlay.classList.remove('confirm-overlay--visible');
                deleteOverlay.setAttribute('aria-hidden', 'true');
                if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    lastFocusedElement.focus();
                }
                deleteFormToSubmit = null;
                if (resetPending) {
                    pendingSubmitForm = null;
                }
            };

            const handleDeleteFormSubmit = (event) => {
                const form = event.target;
                if (!(form instanceof HTMLFormElement) || !form.classList.contains('delete-task-form')) {
                    return;
                }

                if (pendingSubmitForm && pendingSubmitForm === form) {
                    pendingSubmitForm = null;
                    return;
                }

                event.preventDefault();
                const deleteBtn = form.querySelector('.delete-task-btn');
                const taskTitle = deleteBtn?.getAttribute('data-task-title') || 'TASK';
                openDeleteConfirm(taskTitle, form);
            };

            document.addEventListener('submit', handleDeleteFormSubmit, true);

            confirmDeleteBtn?.addEventListener('click', () => {
                if (deleteFormToSubmit) {
                    // Capture the form in a local variable BEFORE closing the modal
                    const formToSubmit = deleteFormToSubmit;

                    pendingSubmitForm = formToSubmit;
                    closeDeleteConfirm(false); // This clears the global deleteFormToSubmit

                    // Submit using the local variable
                    setTimeout(() => {
                        formToSubmit.submit();
                    }, 50);
                }
            });

            cancelDeleteBtn?.addEventListener('click', () => closeDeleteConfirm());

            deleteOverlay?.addEventListener('click', (event) => {
                if (event.target === deleteOverlay) {
                    closeDeleteConfirm();
                }
            });

            document.addEventListener('keydown', (event) => {
                // Handle procrastinate overlay
                if (confirmOverlay?.classList.contains('confirm-overlay--visible')) {
                    if (event.key === 'Escape') {
                        closeConfirmOverlay();
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmProceedBtn?.click();
                    }
                    return;
                }

                // Handle delete overlay
                if (deleteOverlay?.classList.contains('confirm-overlay--visible')) {
                    if (event.key === 'Escape') {
                        closeDeleteConfirm();
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        confirmDeleteBtn?.click();
                    }
                }
            });

            // --- AJAX SORTING & FILTERING LOGIC ---

            // 1. The Function to Fetch and Swap Data
            async function updateTaskGrid() {
                const form = document.getElementById('task-filter-form');
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);

                // Update URL without refreshing (so bookmarks work)
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState({}, '', newUrl);

                try {
                    // Fetch the full HTML of the filtered page
                    const response = await fetch(newUrl);
                    const htmlText = await response.text();

                    // Parse the HTML string into a virtual DOM
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');

                    // Find the new grid and the new empty state
                    const newGrid = doc.querySelector('.tasks-grid');
                    const newEmptyState = doc.querySelector('.empty-state');

                    // Find current containers
                    const currentContainer = document.querySelector('.dashboard');
                    const currentGrid = document.querySelector('.tasks-grid');
                    const currentEmpty = document.querySelector('.empty-state');

                    // Logic to swap content
                    if (newGrid) {
                        // If we have tasks...
                        if (currentGrid) {
                            // Just replace inner content
                            currentGrid.innerHTML = newGrid.innerHTML;
                        } else {
                            // We were empty, now we have tasks. Replace empty state with grid.
                            if (currentEmpty) currentEmpty.remove();
                            // We need to insert the grid after the controls
                            const controls = document.querySelector('.task-controls');
                            // Create wrapper if needed or insert raw HTML
                            controls.insertAdjacentHTML('afterend', newGrid.outerHTML);
                        }
                    } else if (newEmptyState) {
                        // If no tasks found...
                        if (currentGrid) currentGrid.remove();
                        if (currentEmpty) {
                            currentEmpty.innerHTML = newEmptyState.innerHTML;
                        } else {
                            const controls = document.querySelector('.task-controls');
                            controls.insertAdjacentHTML('afterend', newEmptyState.outerHTML);
                        }
                    }

                } catch (error) {
                    console.error('Error fetching tasks:', error);
                }
            }

            // --- CUSTOM TERMINAL DROPDOWN LOGIC ---
            const selectWrappers = document.querySelectorAll('.custom-select-wrapper');

            selectWrappers.forEach(wrapper => {
                const select = wrapper.querySelector('.custom-select');
                const trigger = wrapper.querySelector('.custom-select-trigger');
                const triggerSpan = trigger.querySelector('span');
                const options = wrapper.querySelectorAll('.custom-option');
                const hiddenInput = wrapper.querySelector('input[type="hidden"]');

                trigger.addEventListener('click', function (e) {
                    e.stopPropagation();
                    document.querySelectorAll('.custom-select').forEach(s => {
                        if (s !== select) s.classList.remove('open');
                    });
                    select.classList.toggle('open');
                });

                options.forEach(option => {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();

                        // Visual updates
                        const optionLabel = this.querySelector('.btn-label--baseline-fix');
                        const newLabel = optionLabel && optionLabel.dataset.text ? optionLabel.dataset.text : this.textContent.trim();
                        triggerSpan.textContent = newLabel;
                        triggerSpan.dataset.text = newLabel;
                        options.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');

                        // Data updates
                        hiddenInput.value = this.getAttribute('data-value');
                        select.classList.remove('open');

                        // TRIGGER THE AJAX UPDATE INSTEAD OF SUBMIT
                        updateTaskGrid();
                    });
                });
            });

            // Handle the manual Search Button click too
            const filterForm = document.getElementById('task-filter-form');
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Stop standard reload
                updateTaskGrid();
            });

            document.addEventListener('click', function () {
                document.querySelectorAll('.custom-select').forEach(select => {
                    select.classList.remove('open');
                });
            });

            // --- COUNTDOWN TIMER LOGIC ---
            setInterval(() => {
                const timers = document.querySelectorAll('.task-countdown');
                if (timers.length === 0) return;

                // Get time once per tick for performance
                const now = new Date().getTime();

                timers.forEach(timer => {
                    const dueStr = timer.getAttribute('data-due');
                    if (!dueStr) return;

                    const dueDate = new Date(dueStr).getTime();
                    const diff = dueDate - now;

                    if (diff <= 0) {
                        if (!timer.classList.contains('overdue')) {
                            const overdueText = 'OVERDUE';
                            timer.innerHTML = "<span class='timer-main signalis-glitch' data-text='" + overdueText + "' style='text-align:center; width:auto;'>" + overdueText + "</span>";
                            timer.dataset.text = overdueText;
                            timer.classList.add('overdue');
                        }
                    } else {
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        const ms = Math.floor(diff % 1000);

                        const d = String(days).padStart(2, '0');
                        const h = String(hours).padStart(2, '0');
                        const m = String(minutes).padStart(2, '0');
                        const s = String(seconds).padStart(2, '0');

                        // 1. Get the milliseconds as a string (e.g., "045")
                        const msStr = String(ms).padStart(3, '0');

                        // 2. Wrap EACH digit in a span
                        // "045" -> <span class="ms-digit signalis-glitch" data-text="0">0</span>...
                        const msHtml = msStr.split('')
                            .map(digit => `<span class="ms-digit signalis-glitch" data-text="${digit}">${digit}</span>`)
                            .join('');

                        const mainTime = `${d}D ${h}:${m}:${s}`;

                        // 3. Inject the stable structure
                        timer.innerHTML = `
                    <div class="timer-container">
                        <span class="timer-main signalis-glitch" data-text="${mainTime}">${mainTime}</span>
                        <span class="timer-ms-container">
                            <span class="signalis-glitch" data-text=".">.</span>${msHtml}
                        </span>
                    </div>
                `;

                        timer.classList.remove('overdue');
                    }
                });
            }, 41);
        });
    </script>

    <div class="visual-effects-container">
        <div class="phosphor-mask"></div>

        <div class="interference-line"></div>
        <div class="interference-line"></div>
        <div class="interference-line"></div>
    </div>


    <%- include('partials/footer') %>
