<%- include('partials/header') %>

<div class="dashboard">
    <div class="dashboard-header">
        <h2>TASKS</h2>
        <div class="user-info">
            <a href="/tasks/new" class="btn btn-primary">
                <span class="btn-label--baseline-fix">+ ADD TASK</span>
            </a>
            <a href="/logout" class="btn btn-secondary">
                <span class="btn-label--baseline-fix">LOG OUT</span>
            </a>
        </div>
    </div>

    <div class="task-controls">
        <form action="/tasks" method="GET" class="search-box" id="task-filter-form">
    <input
        type="text"
        name="search"
        placeholder="SEARCH TASKS"
        value="<%= filters.search || '' %>"
    >

    <div class="custom-select-wrapper">
        <div class="custom-select">
            <div class="custom-select-trigger">
                <span><%= !filters.status ? 'ALL STATUS' : filters.status.toUpperCase().replace('-', ' ') %></span>
            </div>
            <div class="custom-options">
                <span class="custom-option <%= !filters.status ? 'selected' : '' %>" data-value="">ALL STATUS</span>
                <span class="custom-option <%= filters.status === 'pending' ? 'selected' : '' %>" data-value="pending">PENDING</span>
                <span class="custom-option <%= filters.status === 'in-progress' ? 'selected' : '' %>" data-value="in-progress">IN PROGRESS</span>
                <span class="custom-option <%= filters.status === 'completed' ? 'selected' : '' %>" data-value="completed">COMPLETED</span>
            </div>
        </div>
        <input type="hidden" name="status" value="<%= filters.status || '' %>">
    </div>

    <div class="custom-select-wrapper">
        <div class="custom-select">
            <div class="custom-select-trigger">
                <span><%= !filters.priority ? 'ALL PRIORITY' : filters.priority.toUpperCase() %></span>
            </div>
            <div class="custom-options">
                <span class="custom-option <%= !filters.priority ? 'selected' : '' %>" data-value="">ALL PRIORITY</span>
                <span class="custom-option <%= filters.priority === 'low' ? 'selected' : '' %>" data-value="low">LOW</span>
                <span class="custom-option <%= filters.priority === 'medium' ? 'selected' : '' %>" data-value="medium">MEDIUM</span>
                <span class="custom-option <%= filters.priority === 'high' ? 'selected' : '' %>" data-value="high">HIGH</span>
            </div>
        </div>
        <input type="hidden" name="priority" value="<%= filters.priority || '' %>">
    </div>

    <div class="custom-select-wrapper">
        <div class="custom-select">
            <div class="custom-select-trigger">
                 <span>
                    <% if(filters.sort === 'oldest') { %> OLDEST FIRST
                    <% } else if(filters.sort === 'dueDate') { %> BY DUE DATE
                    <% } else { %> NEWEST FIRST <% } %>
                 </span>
            </div>
            <div class="custom-options">
                <span class="custom-option <%= filters.sort === 'newest' || !filters.sort ? 'selected' : '' %>" data-value="newest">NEWEST FIRST</span>
                <span class="custom-option <%= filters.sort === 'oldest' ? 'selected' : '' %>" data-value="oldest">OLDEST FIRST</span>
                <span class="custom-option <%= filters.sort === 'dueDate' ? 'selected' : '' %>" data-value="dueDate">BY DUE DATE</span>
            </div>
        </div>
        <input type="hidden" name="sort" value="<%= filters.sort || 'newest' %>">
    </div>

    <button type="submit" class="btn btn-primary btn-small">
        <span class="btn-label--baseline-fix">SEARCH</span>
    </button>
    <a href="/tasks" class="btn btn-secondary btn-small">
        <span class="btn-label--baseline-fix">CLEAR</span>
    </a>
</form>
    </div>

    <% if (typeof tasks !== 'undefined' && tasks.length > 0) { %>
        <div class="tasks-grid">
            <% tasks.forEach((task, index) => { %>
                <a href="/tasks/<%= task._id %>/edit" class="task-card-link">
                    <div class="task-card" data-file-number="<%= String(index + 1).padStart(2, '0') %>">
                        <h3><span class="btn-label--baseline-fix"><%= task.title %></span></h3>

                        <div class="task-timestamp">
                            <%= new Date(task.createdAt || Date.now()).toLocaleDateString('en-GB').replace(/\//g, '/') %>
                            <%= new Date(task.createdAt || Date.now()).toLocaleTimeString('en-GB', { hour12: false }) %>
                        </div>

                        <% if (task.description) { %>
                            <p><%= task.description %></p>
                        <% } else { %>
                            <div class="no-data">NO DESCRIPTION</div>
                        <% } %>

                        <div class="task-meta">
                            <span class="task-status status-<%= task.status %>">
                                <%= task.status.toUpperCase() %>
                            </span>
                            <span class="task-priority priority-<%= task.priority %>">
                                <%= task.priority.toUpperCase() %>
                            </span>
                            <% if (task.dueDate) { %>
                                <span>
                                    DUE: <%= new Date(task.dueDate).toLocaleString('en-GB', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: false
                                    }).replace(',', '') %>
                                </span>
                            <% } %>
                        </div>

                        <div class="task-actions">
                            <form action="/tasks/<%= task._id %>?_method=DELETE" method="POST" style="display: inline;" onclick="event.stopPropagation();">
                                <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('DELETE FILE 00?')">
                                    <span class="btn-label--baseline-fix">DELETE</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </a>
            <% }) %>
        </div>
    <% } else { %>
        <div class="empty-state">
            <h3>NO TASK</h3>
            <a href="/tasks/new" class="btn btn-primary">
                <span class="btn-label--baseline-fix">ADD NEW TASK</span>
            </a>
        </div>
    <% } %>
</div>

<!-- PROCRASTINATE Button -->
<div class="procrastinate-container">
    <button id="procrastinate-btn" class="btn btn-procrastinate">
        <span class="btn-label--baseline-fix">PROCRASTINATE</span>
    </button>
</div>

<div id="regret-overlay">
    <div class="fatal-error-box">
        <h1>YOU WILL REGRET THIS LATER.</h1>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('procrastinate-btn');
        const overlay = document.getElementById('regret-overlay');
        let timeoutId = null;

        // Function to fade out
        const fadeOut = () => {
            // 1. Remove the class to trigger CSS transition (opacity goes to 0)
            overlay.classList.remove('active');

            // 2. Clear the timer so we don't trigger this twice
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
        };

        // Trigger the Red Screen
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            if(confirm("ARE YOU SURE?")) {
                // Make it visible INSTANTLY (no fade in)
                // Temporarily disable transition for instant show
                overlay.style.transition = 'none';
                overlay.classList.add('active');

                // Force a reflow to apply the class without transition
                void overlay.offsetWidth;

                // Restore transition for the fade out
                overlay.style.transition = 'opacity 2s ease-in-out, visibility 2s';

                // Set timer: After 3 seconds, start fading out
                timeoutId = setTimeout(() => {
                    fadeOut();
                }, 1000);
            }
        });
    });
    // ... existing procrastinate code ...

    // Custom Terminal Select Logic
    document.addEventListener('DOMContentLoaded', function() {
        const selectWrappers = document.querySelectorAll('.custom-select-wrapper');

        selectWrappers.forEach(wrapper => {
            const select = wrapper.querySelector('.custom-select');
            const trigger = wrapper.querySelector('.custom-select-trigger');
            const triggerSpan = trigger.querySelector('span');
            const options = wrapper.querySelectorAll('.custom-option');
            const hiddenInput = wrapper.querySelector('input[type="hidden"]');

            // Toggle open/close
            trigger.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent immediate closing
                // Close all other selects first
                document.querySelectorAll('.custom-select').forEach(s => {
                    if(s !== select) s.classList.remove('open');
                });
                select.classList.toggle('open');
            });

            // Option selection
            options.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Update Visuals
                    triggerSpan.textContent = this.textContent;
                    
                    // Remove selected class from siblings
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');

                    // Update Hidden Input Value
                    hiddenInput.value = this.getAttribute('data-value');

                    // Close dropdown
                    select.classList.remove('open');

                    // Submit the form to filter tasks
                    document.getElementById('task-filter-form').submit();
                });
            });
        });

        // Close dropdowns when clicking anywhere else
        document.addEventListener('click', function() {
            document.querySelectorAll('.custom-select').forEach(select => {
                select.classList.remove('open');
            });
        });
    });

</script>

<!-- Add CRT overlay -->
<div class="crt-container">
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div class="refresh-line"></div>
</div>

<%- include('partials/footer') %>
